<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/stylesheets/main.css">
  </head>
  <body id="body" style="background-color:black">
  <header>
    <div id="title">
      <h1>LumiKey</h1>
      <h2>interActive music</h2>
    </div>
    <div id="options">
      <div class="row">
        <label>note width:</label>
        <input type="range" name="noteWidth" min="0" max="200" value="20" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>rho:</label>
        <input type="range" name="rho" min="0" max="500" value="70" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>release speed:</label>
        <input type="range" name="decay" min="0" max="20" value="2" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>attack speed:</label>
        <input type="range" name="attack" min="0.1" max="3" value="1" step="0.1" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>lifetime:</label>
        <input type="range" name="lifetime" min="5" max="500" value="100" oninput="optionChanged(this)">
      </div>
    </div>
  </header>



  
  <script src="/javascripts/visualizer.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/javascripts/timbre.js"></script>
  <script>
    var header =  document.getElementsByTagName('header')[0];
    setTimeout(function(){
      header.setAttribute("class", "fadeOut");
      }, 4000);
    vz.start({'width' : 1440, 'height': 700, 'notes' : 40, 'screen': document.getElementById('body')});
    var socket = io();
    var offset = 40;

    var synth = T("OscGen", {wave:"saw", mul:0.25}).play();
    var midicps = T("midicps");


    function noteOn(noteNumber){
      vz.noteOn(noteNumber);
      synth.noteOnWithFreq(midicps.at(noteNumber), 100);
    }

    function noteOff(noteNumber){
      vz.noteOff(noteNumber);
      synth.noteOff(noteNumber, 100);
    }

    function handleMidiNote(midiData){
      var note = midiData.note;
      switch (note[0]){
        //note on
        case 144:
          noteOn(note[1]-offset);
          break;

        //note off
        case 128: 
          noteOff(note[1]-offset);
          // console.log
          break;

        // pitch wheel
        case 224:
          if(note[2] === 64){
            vz.resetColor();
          } else {
            vz.shiftColor(note[2]);
          }
          break;

        // modwheel + data wheel
        case 176:
          // modwhee;
          if (note[1] == 1) {
            vz.attack = note[2]*3/127;
          } else if (note[1] == 7) {
            vz.rho = note[2]*4 / 127;
          }

        default:
          break;
        }
    }
    
    document.onkeydown = function(event){
      noteOn(event.keyCode);
    };
    document.onkeyup = function(event){
      noteOff(event.keyCode);
    }

    function optionChanged(elem){
      switch  (elem.name){
        case 'rho':
          vz.rho = parseInt(elem.value);
          break;

        case 'noteWidth':
          vz.noteWidth = parseInt(elem.value);
          break;

        case 'decay':
          vz.releaseSpeed = parseInt(elem.value);
          break;

        case 'attack':
          vz.attack = parseFloat(elem.value);
          break;

        case 'lifetime':
          vz.lifetime = parseInt(elem.value);
          break;

        default:
          break;
      }
    }

    // add socket listeners   
    socket.on('midiNote', handleMidiNote);
    socket.on('command', function(data){
        console.log(data);
      }); 
  </script>
  </body>
</html>