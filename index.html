<!doctype html>
<html>
  <head>
    <title>LumiKey</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="stylesheets/main.css">
    <script src="javascripts/jquery.js"></script>
    <!-- // <script src="/javascripts/meyda.js"></script> -->
  </head>
  <body id="body" style="background-color:black">

  <div id="overlay"></div>

  <header>
    <div id="title">
      <h1>LumiKey</h1>
      <h2>interActive music</h2>
      <p>Input: <span id="input"></span></p>
    </div>

    <!-- This is div to allow searching for songs -->
    <!-- <div id="songSearch">
      <div class="row">
        <input type="text" name="songName">
        <button id="search">Load</button>
      </div>
      <div class="row">
          <audio id="tune" controls  src="/Younger.mp3" type="audio/mpeg">
          </audio>
      </div>
    </div> -->
    <div id="options">
      <div class="row">
        <label>note width:</label>
        <input type="range" name="noteWidth" min="0" max="200" value="20" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>rho:</label>
        <input type="range" name="rho" min="0" max="500" value="70" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>release speed:</label>
        <input type="range" name="decay" min="0" max="7" value="2" step="0.1" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>attack speed:</label>
        <input type="range" name="attack" min="0.1" max="3" value="1" step="0.1" oninput="optionChanged(this)">
      </div>
      <div class="row">
        <label>lifetime:</label>
        <input type="range" name="lifetime" min="5" max="500" value="100" oninput="optionChanged(this)">
      </div>
    </div>
  </header>

  <script src="javascripts/visualizer.js"></script>
  <!-- // <script src="/socket.io/socket.io.js"></script> -->
  <!-- // <script src="/javascripts/timbre.js"></script> -->
  <script>

    
    var startOptions = {'width' : window.innerWidth, 'height': window.innerHeight - 100, 'notes' : 48, 'screen': document.getElementById('body')};

    vz.start(startOptions);
    

    // var socket = io();

    var keyLetters = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

    var funky = [];
    var house = [0, 1.3, 2, 5, 20];
    var guitarHero = [0, 1.7, 3.3, 344, 20];
    var pointy = [500, 0.1, 0.8, 123, 0]; // increase width for cool shiiit


    function setMode(options){
      vz.rho = options[0];
      vz.attack = options[1];
      vz.releaseSpeed = options[2];
      vz.lifetime = options[3];
      vz.noteWidth = options[4];
    }

    function noteOn(noteNumber){
      vz.noteOn(noteNumber);
      // synth.noteOnWithFreq(midicps.at(noteNumber), 100);
    }

    function noteOff(noteNumber){
      vz.noteOff(noteNumber);
      // syn  th.noteOff(noteNumber, 100);
    }

    function handleMidiNote(midiData){
      var note = midiData.data;

        //note on
        if (note[0] > 143 && note[0] < 160){
          noteOn(note[1]);

        }
        //note off
        if (note[0] > 127 && note[0] < 144){ 
          noteOff(note[1]);
          // console.log
        }
        // pitch wheel
        if (note[0] == 224){
          if(note[2] === 64){
            vz.resetColors();
            vz.rho = 70;
          } else {
            vz.shiftColor(note[2]);
            vz.rho = note[2]*500 / 127; 
          }
        }
        // modwheel + data wheel
        if(note[0] ==  176){
          // modwhee;
          if (note[1] == 1) {
            vz.attack = note[2]*2/127;
          } else if(note[1] == 7){
            vz.noteWidth = note[2] *200 / 127
          }
        }
      }
        
    
    document.onkeydown = function(event){
      noteOn(event.keyCode);
      if (event.keyCode == 49) {
        setMode(pointy);
      } else if (event.keyCode == 50){
        setMode(guitarHero);
      } else if (event.keyCode == 51){
        setMode(house);
      }
    };
    document.onkeyup = function(event){
      noteOff(event.keyCode);
    }

    function optionChanged(elem){
      switch  (elem.name){
        case 'rho':
          vz.rho = parseInt(elem.value);
          break;

        case 'noteWidth':
          vz.noteWidth = parseInt(elem.value);
          break;

        case 'decay':
          vz.releaseSpeed = parseFloat(elem.value);
          break;

        case 'attack':
          vz.attack = parseFloat(elem.value);
          break;

        case 'lifetime':
          vz.lifetime = parseInt(elem.value);
          break;

        default:
          break;
      }
    }


    var midi = null;  // global MIDIAccess object

    function midiInputsChanged(connectionEvent){
      console.log(connectionEvent);

      // if connection then show connected keyboard
      var portElem = document.getElementById('input');
      if (midi.inputs.size > 0) {
        // for now just grab first port
        var port = midi.inputs.values().next().value;
        console.log(port);
        portElem.innerHTML = port.name;
      } else {
        portElem.innerHTML = "empty";
      }

    }

    function onMIDISuccess(midiAccess) {
      midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
      midi.onstatechange = midiInputsChanged;
      midiAccess.inputs.forEach( function(entry) {entry.onmidimessage = handleMidiNote;});
    }

    function onMIDIFailure(msg) {
      console.log( "Failed to get MIDI access - " + msg );
    }

    navigator.requestMIDIAccess().then( onMIDISuccess, onMIDIFailure );



  </script>
  </body>
</html>